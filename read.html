<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GrammarBuddy Read Aloud</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap');

    body {
        font-family: 'Montserrat', sans-serif;
        background-color: #f3f4f6;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        color: #334155;
    }

    .app-container {
        width: 90vw;
        max-width: 700px;
        background-color: #ffffff;
        border-radius: 2rem; /* Even more rounded corners for a modern feel */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08), 0 4px 8px rgba(0, 0, 0, 0.05); /* Softer, layered shadow */
        position: relative;
        display: flex;
        flex-direction: column;
        padding: 2.5rem; /* Increased padding */
        box-sizing: border-box;
        overflow: hidden;
    }

    /* Heading */
    .app-header {
        text-align: center;
        font-size: 2.2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1.5rem;
    }
    .app-header i {
        color: #4b44ec; /* Deep blue accent */
        margin-right: 0.75rem;
    }

    /* Level buttons */
    .level-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .level-btn {
        padding: 0.7rem 1.5rem;
        border: none;
        border-radius: 2rem; /* Pill shape */
        font-weight: 600;
        cursor: pointer;
        background-color: #d1d5db; /* Neutral gray */
        color: #4b5563;
        transition: all 0.2s ease;
    }
    .level-btn:hover {
        background-color: #9ca3af;
    }
    .level-btn.selected {
        background-color: #3b82f6; /* Vibrant blue for active state */
        color: white;
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
    }

    .progress-bar-container {
        width: 100%;
        height: 8px;
        background-color: #e5e7eb;
        border-radius: 4px;
        margin-bottom: 1.5rem;
    }

    .progress-bar {
        height: 100%;
        width: 0;
        background-color: #3b82f6;
        border-radius: 4px;
        transition: width 0.1s linear;
    }

    .screen {
        flex: 1;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f9fafb;
        border-radius: 1rem;
        padding: 2rem 1rem;
        box-sizing: border-box;
    }

    .scroll-text {
        position: absolute;
        width: 100%;
        line-height: 1.8; /* Increased line height for better readability */
        text-align: center;
        box-sizing: border-box;
        transform: translateY(100%);
        color: #4b5563;
        font-weight: 300; /* Lighter font weight for a modern look */
    }

    .controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-weight: 600;
        color: #4a5568;
    }

    .control-group input[type="range"] {
        -webkit-appearance: none;
        width: 200px;
        height: 8px;
        background: #d1d5db;
        border-radius: 4px;
        outline: none;
        transition: background 0.3s ease;
    }
    .control-group input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #3b82f6; /* Match primary button color */
        cursor: pointer;
        border: 4px solid #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .btn-group {
        display: flex;
        gap: 1rem;
    }

    .btn {
        padding: 0.8rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border: none;
        border-radius: 2rem; /* Pill shape for buttons */
        color: white;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .btn:hover {
        transform: translateY(-2px);
    }
    .btn-start { background-color: #3b82f6; }
    .btn-pause { background-color: #f59e0b; }
    .btn-reset { background-color: #ef4444; }

    /* Countdown overlay */
    .overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 5rem;
        font-weight: 700;
        color: #1f2937;
        z-index: 10;
        border-radius: 2rem;
    }
</style>
</head>
<body>
<div class="app-container">
    <div class="app-header">
        <i class="fas fa-graduation-cap"></i> GrammarBuddy Read Aloud
    </div>

    <div class="level-buttons">
        <button class="level-btn" id="easy-btn">Easy</button>
        <button class="level-btn" id="difficult-btn">Difficult</button>
        <button class="level-btn" id="hard-btn">Hard</button>
    </div>

    <div class="progress-bar-container">
        <div id="progress-bar" class="progress-bar"></div>
    </div>
    <div class="screen">
        <div id="scroll-container" class="scroll-text">
            <p id="main-text"></p>
        </div>
        <div id="overlay" class="overlay" style="display: none;"></div>
    </div>
    <div class="controls">
        <div class="control-group">
            <label for="speed-slider">Speed:</label>
            <input type="range" id="speed-slider" min="50" max="300" value="150" step="10">
            <span id="speed-value">150 WPM</span>
        </div>
        <div class="btn-group">
            <button id="start-btn" class="btn btn-start">Start</button>
            <button id="pause-btn" class="btn btn-pause" style="display: none;">Pause</button>
            <button id="reset-btn" class="btn btn-reset" style="display: none;">Reset</button>
        </div>
    </div>
</div>

<script>
window.onload = function() {
    const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/1rkSxjJHT4enuqDaPVCBN7LNSRjFxPtQV0E1V9OD-zgc/gviz/tq?tqx=out:json&sheet=Read';

    const startBtn = document.getElementById('start-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const resetBtn = document.getElementById('reset-btn');
    const scrollContainer = document.getElementById('scroll-container');
    const mainTextElement = document.getElementById('main-text');
    const speedSlider = document.getElementById('speed-slider');
    const speedValueDisplay = document.getElementById('speed-value');
    const progressBar = document.getElementById('progress-bar');
    const overlay = document.getElementById('overlay');
    const levelButtons = document.querySelectorAll('.level-btn');
    
    let allPassages = [];
    let selectedLevel = 'Easy';
    let animationFrameId = null;
    let startTime = null;
    let totalAnimationDuration = 0;
    let isPaused = false;
    
    document.getElementById('easy-btn').classList.add('selected');

    function fetchPassages() {
        fetch(SPREADSHEET_URL)
            .then(res => res.text())
            .then(text => {
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = JSON.parse(jsonText);
                const rows = data.table.rows;
                
                allPassages = rows.map(row => {
                    const level = row.c[1]?.v;
                    const passage = row.c[2]?.v;
                    return { level, passage };
                }).filter(p => p.level && p.passage);
                
                console.log('Passages loaded:', allPassages.length);
            })
            .catch(err => {
                console.error('Failed to fetch passages:', err);
                alert('Failed to load passages from the spreadsheet.');
            });
    }

    fetchPassages();

    function setSpeed(wpm, wordCount) {
        if (wordCount === 0) {
            totalAnimationDuration = 0;
            return;
        }
        const durationInSeconds = (wordCount / wpm) * 60;
        totalAnimationDuration = durationInSeconds;

        const styleTag = document.querySelector('style') || document.createElement('style');
        styleTag.innerHTML = `
            @keyframes scroll {
                0% { transform: translateY(100%); }
                100% { transform: translateY(-100%); }
            }
        `;
        document.head.appendChild(styleTag);
    }
    
    function updateProgressBar(timestamp) {
        if (!startTime) startTime = timestamp;
        const elapsed = (timestamp - startTime) / 1000;
        const progress = (elapsed / totalAnimationDuration) * 100;
        progressBar.style.width = `${Math.min(progress, 100)}%`;
        if (progress < 100 && !isPaused) {
            animationFrameId = requestAnimationFrame(updateProgressBar);
        }
    }

    function showCountdownAndStart(passageText) {
        overlay.style.display = 'flex';
        let count = 3;
        overlay.textContent = count;
        const countdownInterval = setInterval(() => {
            count--;
            if (count > 0) {
                overlay.textContent = count;
            } else {
                clearInterval(countdownInterval);
                overlay.textContent = "Get Ready to Read!";
                overlay.style.fontSize = "3rem";
                setTimeout(() => {
                    overlay.style.display = 'none';
                    startScroll(passageText);
                }, 1000);
            }
        }, 1000);
    }

    function startScroll(passageText) {
        mainTextElement.textContent = passageText;
        
        const wordCount = passageText.trim().split(/\s+/).length;
        setSpeed(speedSlider.value, wordCount);
        
        scrollContainer.style.animation = 'none';
        progressBar.style.width = '0%';
        scrollContainer.style.transform = `translateY(100%)`;

        setTimeout(() => {
            scrollContainer.style.animation = `scroll ${totalAnimationDuration}s linear forwards`;
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'block';
            resetBtn.style.display = 'block';

            startTime = null;
            isPaused = false;
            animationFrameId = requestAnimationFrame(updateProgressBar);
        }, 10);
    }

    startBtn.addEventListener('click', () => {
        const filteredPassages = allPassages.filter(p => p.level?.toLowerCase() === selectedLevel?.toLowerCase());
        if (filteredPassages.length > 0) {
            const randomIndex = Math.floor(Math.random() * filteredPassages.length);
            const passageToRead = filteredPassages[randomIndex].passage;
            showCountdownAndStart(passageToRead);
        } else {
            alert(`No passages found for the selected level: ${selectedLevel}`);
        }
    });

    pauseBtn.addEventListener('click', () => {
        if (isPaused) {
            scrollContainer.style.animationPlayState = 'running';
            pauseBtn.textContent = 'Pause';
            isPaused = false;
            startTime = performance.now() - (totalAnimationDuration * (parseFloat(progressBar.style.width) / 100) * 1000);
            animationFrameId = requestAnimationFrame(updateProgressBar);
        } else {
            scrollContainer.style.animationPlayState = 'paused';
            pauseBtn.textContent = 'Resume';
            isPaused = true;
            cancelAnimationFrame(animationFrameId);
        }
    });

    resetBtn.addEventListener('click', () => {
        scrollContainer.style.animation = 'none';
        scrollContainer.style.transform = `translateY(100%)`;
        mainTextElement.textContent = "";
        startBtn.style.display = 'block';
        pauseBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        pauseBtn.textContent = 'Pause';
        progressBar.style.width = '0%';
        cancelAnimationFrame(animationFrameId);
    });

    speedSlider.addEventListener('input', (event) => {
        const newSpeed = event.target.value;
        speedValueDisplay.textContent = `${newSpeed} WPM`;
        if (!isPaused) {
          const wordCount = mainTextElement.textContent.trim().split(/\s+/).length;
          setSpeed(newSpeed, wordCount);
        }
    });

    levelButtons.forEach(button => {
        button.addEventListener('click', () => {
            levelButtons.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedLevel = button.textContent;
            resetBtn.click();
        });
    });
};
</script>
</body>
</html>
