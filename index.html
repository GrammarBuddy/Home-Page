<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GrammarBuddy</title>
  <link rel="stylesheet" href="tailwind.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">

  <!-- Top Bar -->
  <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
    <div class="text-xl font-bold">GrammarBuddy</div>
    <button onclick="toggleTheme()" class="text-sm border px-2 py-1 rounded dark:border-gray-600">Toggle Theme</button>
  </div>

  <!-- Progress Bar -->
  <div class="w-full bg-gray-300 h-2 dark:bg-gray-700">
    <div id="progressBar" class="h-full bg-green-500 transition-all duration-300" style="width: 0%"></div>
  </div>

  <!-- Welcome Section -->
  <section id="welcomeSection" class="p-4 text-center">
    <h2 class="text-2xl font-semibold mb-2">Welcome to GrammarBuddy</h2>
    <p class="mb-4">Choose your level and begin the challenge!</p>

    <input id="username" placeholder="Enter username" class="border rounded px-3 py-2 w-full max-w-sm mx-auto mb-2" />
    <input id="email" type="email" placeholder="Enter email" class="border rounded px-3 py-2 w-full max-w-sm mx-auto mb-4" />

    <select id="levelSelector" class="border rounded px-3 py-2">
      <option value="prekg">Pre-KG</option>
      <option value="lowerprimary">Lower Primary</option>
      <option value="upperprimary">Upper Primary</option>
      <option value="secondary">Secondary</option>
      <option value="phd">PhD</option>
    </select>
    <button onclick="startQuiz()" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded">Start</button>
  </section>

  <!-- Loading -->
  <section id="loadingSection" class="hidden text-center p-4">
    <p class="text-lg font-medium">Loading questions...</p>
    <div class="mt-2 flex justify-center space-x-1">
      <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
      <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-150"></div>
      <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce delay-300"></div>
    </div>
  </section>

  <!-- Quiz Section -->
  <section id="quizSection" class="hidden p-4">
    <div id="questionContainer" class="mb-4"></div>
    <div class="flex justify-between">
      <button onclick="prevQuestion()" class="px-4 py-2 bg-gray-300 rounded">Previous</button>
      <button onclick="cancelQuiz()" class="px-4 py-2 bg-red-500 text-white rounded">Cancel</button>
      <button onclick="nextQuestion()" class="px-4 py-2 bg-green-500 text-white rounded">Next</button>
    </div>
  </section>

  <!-- Scoring Loading Section -->
  <section id="scoringSection" class="hidden text-center p-4">
    <p class="text-lg font-medium">Evaluating your answers...</p>
    <div class="mt-2 flex justify-center space-x-1">
      <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce"></div>
      <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce delay-150"></div>
      <div class="w-2 h-2 bg-green-500 rounded-full animate-bounce delay-300"></div>
    </div>
  </section>

  <!-- Result Section -->
  <section id="resultSection" class="hidden p-4 text-center">
    <div id="scoreElement" class="text-2xl font-bold mb-2"></div>
    <div id="rankLabel" class="text-lg font-medium mb-4"></div>
    <div id="resultContainer" class="space-y-4 mb-6"></div>
    <button onclick="restartQuiz()" class="px-4 py-2 bg-blue-500 text-white rounded">Take Another Quiz</button>
  </section>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbykudOv6ZaK_ACqwCa4g6gWbame5bOJ6g3sMb2wwYnkb1rUxvASQlHFXNd4U4MbaBdE/exec";
    let questions = [], currentQuestion = 0, userAnswers = [], selectedLevel = "";

    window.addEventListener("DOMContentLoaded", () => {
      const storedUsername = localStorage.getItem("grammarbuddy_username");
      const storedEmail = localStorage.getItem("grammarbuddy_email");
      if (storedUsername) document.getElementById("username").value = storedUsername;
      if (storedEmail) document.getElementById("email").value = storedEmail;
    });

    function toggleTheme() {
      const html = document.documentElement;
      html.classList.toggle("dark");
      localStorage.setItem("theme", html.classList.contains("dark") ? "dark" : "light");
    }

    function toggleSection(id, show) {
      document.getElementById(id).classList.toggle("hidden", !show);
    }

    function updateProgressBar() {
      const percent = ((currentQuestion + 1) / questions.length) * 100;
      document.getElementById("progressBar").style.width = percent + "%";
    }

    function startQuiz() {
      const username = document.getElementById("username").value.trim();
      const email = document.getElementById("email").value.trim();
      selectedLevel = document.getElementById("levelSelector").value;

      if (!username || !email) {
        alert("GrammarBuddy says: Please enter both username and email.");
        return;
      }

      localStorage.setItem("grammarbuddy_username", username);
      localStorage.setItem("grammarbuddy_email", email);

      toggleSection("welcomeSection", false);
      toggleSection("loadingSection", true);

      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({ action: "getQuestions", level: selectedLevel })
      })
      .then(res => res.json())
      .then(data => {
        questions = data;
        userAnswers = Array(questions.length).fill(null);
        currentQuestion = 0;
        toggleSection("loadingSection", false);
        toggleSection("quizSection", true);
        showQuestion();
      })
      .catch(() => alert("GrammarBuddy says: Error loading questions."));
    }

    function showQuestion() {
      updateProgressBar();
      const q = questions[currentQuestion];
      const container = document.getElementById("questionContainer");
      container.innerHTML = `
        <div class="mb-2 font-semibold">Q${currentQuestion + 1}: ${q.question}</div>
        <div class="space-y-2">
          ${q.options.map((opt, i) => `
            <label class="block border rounded p-2 cursor-pointer ${userAnswers[currentQuestion] === opt ? 'bg-green-100 dark:bg-green-800' : ''}">
              <input type="radio" name="option" value="${opt}" class="mr-2" ${userAnswers[currentQuestion] === opt ? 'checked' : ''}/>
              ${opt}
            </label>
          `).join("")}
        </div>`;
    }

    function nextQuestion() {
      const selected = document.querySelector('input[name="option"]:checked');
      if (!selected) return alert("GrammarBuddy says: Please select an answer.");
      userAnswers[currentQuestion] = selected.value;

      if (currentQuestion < questions.length - 1) {
        currentQuestion++;
        showQuestion();
      } else {
        showScore();
      }
    }

    function prevQuestion() {
      if (currentQuestion > 0) {
        currentQuestion--;
        showQuestion();
      }
    }

    function cancelQuiz() {
      if (confirm("Are you sure you want to cancel the quiz?")) resetAll();
    }

    function restartQuiz() {
      resetAll();
    }

    function resetAll() {
      questions = [];
      userAnswers = [];
      currentQuestion = 0;
      toggleSection("quizSection", false);
      toggleSection("resultSection", false);
      toggleSection("welcomeSection", true);
      updateProgressBar();
    }

    function showScore() {
      toggleSection("quizSection", false);
      toggleSection("scoringSection", true);

      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({
          action: "submitQuiz",
          questions,
          answers: userAnswers
        })
      })
      .then(res => res.json())
      .then(({ score, result }) => {
        const total = questions.length;
        const storedUsername = localStorage.getItem("grammarbuddy_username");
        const storedEmail = localStorage.getItem("grammarbuddy_email");

        // Save user data
        fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify({
            action: "saveScore",
            username: storedUsername,
            email: storedEmail,
            level: selectedLevel,
            score
          })
        });

        // Show confetti if high score
        if (score >= 8) confetti();

        // Show result
        const scoreElement = document.getElementById("scoreElement");
        scoreElement.innerHTML = `<h2 class="text-xl font-semibold mb-2">${storedUsername}, your score is: ${score}/${total}</h2>`;

        const rankLabel = document.getElementById("rankLabel");
        rankLabel.textContent = score >= 9 ? "üèÜ Grammar Genius!" :
                                score >= 7 ? "üåü Excellent Effort!" :
                                score >= 5 ? "üëç Good Try!" :
                                "üìò Keep Practicing!";

        const container = document.getElementById("resultContainer");
        container.innerHTML = result.map((res, i) => `
          <div class="border p-3 rounded ${res.correct ? 'bg-green-100 dark:bg-green-800' : 'bg-red-100 dark:bg-red-800'}">
            <div class="font-semibold">Q${i + 1}: ${res.question}</div>
            <div>${res.correct ? '‚úÖ' : '‚ùå'} Your Answer: ${res.yourAnswer}</div>
            <div>‚úÖ Correct Answer: ${res.correctAnswer}</div>
            <div class="mt-1"><strong>Explanation:</strong> ${res.explanation}</div>
          </div>
        `).join("");

        toggleSection("scoringSection", false);
        toggleSection("resultSection", true);
      })
      .catch(() => alert("GrammarBuddy says: Error evaluating answers."));
    }
  </script>
</body>
</html>
