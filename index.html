// New function to shuffle an array
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// Rewritten showQuestion function to randomize options
function showQuestion() {
    const q = currentQuestions[currentQuestionIndex];
    const questionContentWrapper = document.getElementById('questionContentWrapper');
    const questionTextElement = document.getElementById('questionText');
    const optionsDiv = document.getElementById('options');

    optionsDiv.innerHTML = '';

    let topicInfoElement = document.getElementById('topicInfo');
    if (!topicInfoElement) {
        topicInfoElement = document.createElement('p');
        topicInfoElement.id = 'topicInfo';
        topicInfoElement.className = 'text-xs text-gray-500 dark:text-gray-400 mb-1';
        questionContentWrapper.insertBefore(topicInfoElement, questionTextElement);
    }
    topicInfoElement.textContent = `Topic: ${q.Topic} | Question ID: ${q.Question_ID}`;

    questionTextElement.textContent = `${currentQuestionIndex + 1}. ${q.Question_Text}`;

    // Get all options and their corresponding letters
    const optionsData = [
        { key: 'A', text: q.Option_A },
        { key: 'B', text: q.Option_B },
        { key: 'C', text: q.Option_C },
        { key: 'D', text: q.Option_D }
    ].filter(option => option.text.trim() !== ''); // Filter out empty options

    // Shuffle the options array
    shuffleArray(optionsData);

    const qid = q.Question_ID;
    const userSelectedAnswer = userAnswers[qid];

    // Create and append the options in the new shuffled order
    optionsData.forEach(option => {
        const label = document.createElement('label');
        const isSelected = userSelectedAnswer === option.key;
        label.className = `block border rounded px-4 py-3 cursor-pointer dark:border-gray-600 interactive-element hover:bg-gray-100 dark:hover:bg-gray-700 ${isSelected ? 'selected-option' : ''}`;
        
        // We'll pass the original key to the selectOption function
        label.onclick = () => selectOption(option.key); 
        
        const input = document.createElement('input');
        input.type = 'radio'; input.name = 'option'; input.value = option.key; input.className = 'mr-2 hidden';
        input.checked = isSelected;
        label.appendChild(input);
        
        // We can just use the option's text here without the letter
        label.appendChild(document.createTextNode(`${option.text}`));
        optionsDiv.appendChild(label);
    });

    document.getElementById('prevButton').classList.toggle('disabled-button', currentQuestionIndex === 0);
    const nextButton = document.getElementById('nextButton');
    nextButton.textContent = (currentQuestionIndex === currentQuestions.length - 1) ? 'Submit & See Results' : 'Next';
    nextButton.classList.toggle('bg-secondary', currentQuestionIndex === currentQuestions.length - 1);
    nextButton.classList.toggle('bg-primary', currentQuestionIndex !== currentQuestions.length - 1);
    updateProgressBar();
}

// This function needs a small modification to correctly handle the new structure
function selectOption(key) {
    const qid = currentQuestions[currentQuestionIndex].Question_ID;
    userAnswers[qid] = key;
    const optionsDiv = document.getElementById('options');

    optionsDiv.querySelectorAll('label').forEach(label => label.classList.remove('selected-option'));

    // We now use the original option key to find and highlight the selected option
    const selectedLabel = optionsDiv.querySelector(`input[value="${key}"]`);
    if (selectedLabel) {
        selectedLabel.parentElement.classList.add('selected-option');
    }
}
