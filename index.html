// This function is still here for backward compatibility with the original web app URL,
// which serves the HTML file from the Apps Script environment.
function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/**
 * This is the central API endpoint for all requests from the GitHub Pages web app.
 * It routes requests to the correct function based on the 'action' field in the payload.
 * @param {object} e The event object containing the POST data.
 * @returns {object} A JSON response with the result of the action.
 */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    let result;

    switch (action) {
      case 'getQuestions':
        result = getQuizQuestions(data.level);
        break;
      case 'submitQuiz':
        result = submitQuiz(JSON.stringify(data.userAnswers));
        break;
      case 'saveScore':
        // The saveScore action now correctly passes the email field.
        result = saveUserData(data.username, data.level, data.score, data.email);
        break;
      default:
        return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Invalid action' }))
          .setMimeType(ContentService.MimeType.JSON);
    }

    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    Logger.log('Error in doPost: ' + err.message);
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Server error: ' + err.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Fetches a random set of 10 quiz questions for a specific level from the Google Sheet.
 * @param {string} level The selected quiz level.
 * @returns {Array<object>} An array of question objects.
 */
function getQuizQuestions(level) {
  // Your questions spreadsheet ID from the user's provided script
  const sheetId = "1vPcimkpqRwKx1_JTAE66EEFUCaDQtyRErb-uyP4a054"; 
  const sheet = SpreadsheetApp.openById(sheetId).getSheetByName("Questions");
  if (!sheet) {
    return { error: "Could not find the 'Questions' sheet. Please check your spreadsheet." };
  }
  const data = sheet.getDataRange().getValues();

  const headers = data[0];
  const rows = data.slice(1);

  const filtered = rows.filter(row => row[headers.indexOf("Level")] === level);
  const shuffled = filtered.sort(() => 0.5 - Math.random());
  const questions = shuffled.slice(0, 10).map(row => {
    return {
      questionId: row[headers.indexOf("Question_ID")],
      topic: row[headers.indexOf("Topic")],
      questionText: row[headers.indexOf("Question_Text")],
      options: {
        A: row[headers.indexOf("Option_A")],
        B: row[headers.indexOf("Option_B")],
        C: row[headers.indexOf("Option_C")],
        D: row[headers.indexOf("Option_D")]
      },
      correctAnswer: row[headers.indexOf("Correct_Answer")],
      explanation: row[headers.indexOf("Explanation")]
    };
  });
  return questions;
}

/**
 * Evaluates the user's submitted answers against the correct answers in the Google Sheet.
 * @param {string} userAnswersJson A JSON string of the user's answers.
 * @returns {object} An object containing the score, total questions, and detailed results.
 */
function submitQuiz(userAnswersJson) {
  try {
    const userAnswers = JSON.parse(userAnswersJson);
    const sheetId = "1vPcimkpqRwKx1_JTAE66EEFUCaDQtyRErb-uyP4a054";
    const sheet = SpreadsheetApp.openById(sheetId).getSheetByName("Questions");
    if (!sheet) {
      return { error: "Could not find the 'Questions' sheet. Please check your spreadsheet." };
    }
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1);

    let score = 0;
    let total = Object.keys(userAnswers).length;
    let results = [];

    const questionsMap = new Map();
    rows.forEach(row => {
      const qid = row[headers.indexOf("Question_ID")];
      questionsMap.set(qid, {
        correctAnswer: row[headers.indexOf("Correct_Answer")],
        questionText: row[headers.indexOf("Question_Text")],
        explanation: row[headers.indexOf("Explanation")]
      });
    });

    for (const qid in userAnswers) {
      if (questionsMap.has(qid)) {
        const questionData = questionsMap.get(qid);
        const correct = questionData.correctAnswer;
        const isCorrect = userAnswers[qid] === correct;
        if (isCorrect) score++;

        results.push({
          questionId: qid,
          questionText: questionData.questionText,
          userAnswer: userAnswers[qid],
          correctAnswer: correct,
          explanation: questionData.explanation,
          isCorrect: isCorrect
        });
      }
    }

    return {
      score: score,
      total: total,
      results: results
    };

  } catch (e) {
    Logger.log(e.message);
    return {
      error: "An error occurred while submitting the quiz. Please try again."
    };
  }
}

/**
 * Saves the user's quiz data (username, level, score, email) to the specified spreadsheet.
 * The order of the fields is critical to match the spreadsheet columns.
 * @param {string} username The user's name.
 * @param {string} level The quiz level.
 * @param {string} score The user's final score (e.g., "10/10").
 * @param {string} email The user's email address.
 * @returns {object} An object indicating success or failure.
 */
function saveUserData(username, level, score, email) {
  try {
    const spreadsheetId = "152CT6x9AdiVCS0K40rYjA0qvjTSo1WfV25JJnHNjXAg";
    const sheet = SpreadsheetApp.openById(spreadsheetId).getSheetByName("UserInfoSheet");
    if (!sheet) {
      return { success: false, message: "Could not find the 'UserInfoSheet' sheet. Please check your spreadsheet." };
    }

    const lastRow = sheet.getLastRow();

    if (lastRow > 1) {
      const existingUsernames = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
      if (existingUsernames.includes(username)) {
        return { success: false, message: "Username already exists. Please choose a different one." };
      }
    }

    // This is the corrected line to append the row with the correct field order
    // to match the spreadsheet columns: Timestamp, Username, Level, Email, Score.
    sheet.appendRow([new Date(), username, level, email, score]);

    return { success: true, message: "Your score has been saved!" };

  } catch (e) {
    Logger.log("Error in saveUserData: " + e.message);
    return { success: false, message: "An error occurred while saving your score. Please try again." };
  }
}
