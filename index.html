<!DOCTYPE html>
<html lang="en" class="light">
<head>
Â  Â  <meta charset="UTF-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  Â  <title>GrammarBuddy</title>
Â  Â Â 
Â  Â  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>">
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

Â  Â  <script>
Â  Â  Â  Â  tailwind.config = {
Â  Â  Â  Â  Â  Â  darkMode: 'class',
Â  Â  Â  Â  Â  Â  theme: {
Â  Â  Â  Â  Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  primary: { DEFAULT: '#2563eb', light: '#93c5fd', dark: '#1e40af' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  secondary: { DEFAULT: '#10b981' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  };
Â  Â  </script>
Â  Â  <style>
Â  Â  Â  Â  /* Base styles for a smooth, responsive experience */
Â  Â  Â  Â  html, body { height: 100%; margin: 0; padding: 0; overflow-x: hidden; transition: background-color 0.3s ease, color 0.3s ease; }
Â  Â  Â  Â  .loader { display: inline-block; width: 1rem; height: 1rem; border-radius: 50%; background-color: currentColor; animation: bounce 0.6s infinite alternate; }
Â  Â  Â  Â  .loader:nth-child(2) { animation-delay: 0.2s; }
Â  Â  Â  Â  .loader:nth-child(3) { animation-delay: 0.4s; }
Â  Â  Â  Â  @keyframes bounce { from { transform: translateY(0); opacity: 0.3; } to { transform: translateY(-0.6rem); opacity: 1; } }
Â  Â  Â  Â  .disabled-button { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

Â  Â  Â  Â  /* --- Hamburger Menu Styles --- */
Â  Â  Â  Â  .hamburger { cursor: pointer; width: 24px; height: 24px; transition: all 0.25s; position: relative; }
Â  Â  Â  Â  .hamburger-top, .hamburger-middle, .hamburger-bottom { position: absolute; left: 0; width: 24px; height: 2px; background: #374151; transition: all 0.4s; }
Â  Â  Â  Â  .dark .hamburger-top, .dark .hamburger-middle, .dark .hamburger-bottom { background: #f3f4f6; }
Â  Â  Â  Â  .hamburger-middle { transform: translateY(7px); }
Â  Â  Â  Â  .hamburger-bottom { transform: translateY(14px); }
Â  Â  Â  Â  .open .hamburger-top { transform: rotate(45deg) translateY(6px) translateX(6px); }
Â  Â  Â  Â  .open .hamburger-middle { display: none; }
Â  Â  Â  Â  .open .hamburger-bottom { transform: rotate(-45deg) translateY(6px) translateX(-6px); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* New styling for the selected option in the quiz */
Â  Â  Â  Â  .selected-option {Â 
Â  Â  Â  Â  Â  Â  background-color: var(--primary-light, #93c5fd);
Â  Â  Â  Â  Â  Â  border-color: var(--primary, #2563eb);
Â  Â  Â  Â  Â  Â  transform: scale(1.02);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
Â  Â  Â  Â  Â  Â  transition: all 0.2s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark .selected-option {
Â  Â  Â  Â  Â  Â  background-color: #1e40af;
Â  Â  Â  Â  Â  Â  border-color: #93c5fd;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="bg-white text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors">
Â  Â Â 
Â  Â  Â  Â  <div id="sidebar-menu" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800 shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out">
Â  Â  Â  Â  <div class="p-5 pt-16"> Â  Â  Â  Â  Â  Â  <nav class="flex flex-col space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://grammarbuddy.github.io/homepage/" class="text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light transition-colors py-2">Home</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://sites.google.com/view/gbspellbee/home" class="text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light transition-colors py-2">Spelling Bee</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://sites.google.com/view/titatov3/home" class="text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light transition-colors py-2">TaTiTo Code</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://www.google.com" class="text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light transition-colors py-2">Careers</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://www.google.com" class="text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light transition-colors py-2">About Us</a>
Â  Â  Â  Â  Â  Â  </nav>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  Â  Â  <div id="menu-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
Â  Â Â 
Â  Â  Â  Â  <div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
Â  Â  Â  Â  <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full mx-4">
Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold mb-4">Are you sure?</h3>
Â  Â  Â  Â  Â  Â  <p class="mb-6">GrammarBuddy says: Do you want to cancel the quiz? Your progress will be lost.</p>
Â  Â  Â  Â  Â  Â  <div class="flex justify-center space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="confirmCancelBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg interactive-element hover:bg-red-600 transition-colors">Yes, cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="dismissCancelBtn" class="bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white px-4 py-2 rounded-lg interactive-element hover:bg-gray-400 dark:hover:bg-gray-700 transition-colors">No, continue</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>


Â  Â  <div id="quizContainer" class="max-w-xl mx-auto px-4 py-6">

Â  Â  Â  Â  Â  Â  Â  Â  <header class="relative flex justify-between items-center mb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="menu-btn" class="z-50 block hamburger focus:outline-none">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="hamburger-top"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="hamburger-middle"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="hamburger-bottom"></span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-1 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h1 class="text-2xl sm:text-3xl font-bold text-primary dark:text-primary-light">GrammarBuddy</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-xs text-gray-900 dark:text-white mt-1">For Pre-KG to PhD Learners!</p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-1 text-right">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="themeToggler" onclick="toggleTheme()" class="text-sm bg-gray-200 dark:bg-gray-700 dark:text-gray-200 px-3 py-1 rounded interactive-element">Theme</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <div class="w-full bg-gray-200 dark:bg-gray-700 h-3 rounded mb-4">
Â  Â  Â  Â  Â  Â  <div id="progressBar" class="bg-primary h-3 rounded transition-all duration-300" style="width: 0%"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="welcomeSection">
Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold text-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“ Welcome to <span class="text-primary dark:text-primary-light">GrammarBuddy!</span>
Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  <p class="text-center mb-4">Explore English in a whole new way â€” playful, powerful, and for every level!</p>
Â  Â  Â  Â  Â  Â  <input type="text" id="usernameInput" placeholder="Ready to begin? Name your avatar!" maxlength="10" class="w-full border rounded p-2 mb-4 dark:bg-gray-800 dark:border-gray-600 interactive-element" pattern="[a-zA-Z0-9]{1,10}">
Â  Â  Â  Â  Â  Â  <select id="levelSelect" class="w-full border rounded p-2 mb-4 dark:bg-gray-800 dark:border-gray-600 interactive-element">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Select Level --</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>Pre-KG</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>Kindergarten</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>Lower Primary (1&2)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>Upper Primary (3-5)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>Middle School (6-8)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>Secondary (9&10)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>Senior Secondary (11&12)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>Graduation</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>Post Graduation</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option>PhD</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <button onclick="startQuiz()" class="bg-primary text-white px-4 py-2 rounded w-full interactive-element">
Â  Â  Â  Â  Â  Â  Â  Â  Start Challenge
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="loadingSection" class="hidden text-center py-12">
Â  Â  Â  Â  Â  Â  <p class="text-lg font-semibold mb-4">Fetching live questions...</p>
Â  Â  Â  Â  Â  Â  <div class="flex justify-center space-x-2 text-primary dark:text-primary-light">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="loader"></span><span class="loader"></span><span class="loader"></span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="quizSection" class="hidden">
Â  Â  Â  Â  Â  Â  <div id="questionContentWrapper" class="transition-all duration-300 ease-in-out">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="questionText" class="text-lg font-semibold mb-4"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="options" class="space-y-3 mb-4"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showCancelModal()" class="text-sm text-red-500 underline">Cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="prevButton" onclick="prevQuestion()" class="bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white px-3 py-2 rounded disabled-button interactive-element">Previous</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="nextButton" onclick="nextQuestion()" class="bg-primary text-white px-4 py-2 rounded interactive-element">Next</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="scoringSection" class="hidden text-center py-12">
Â  Â  Â  Â  Â  Â  <p class="text-lg font-semibold mb-4">Calculating your score...</p>
Â  Â  Â  Â  Â  Â  <div class="flex justify-center space-x-2 text-primary dark:text-primary-light">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="loader"></span><span class="loader"></span><span class="loader"></span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="resultSection" class="hidden">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-center mb-2">Your Results</h2>
Â  Â  Â  Â  Â  Â  <h3 id="userWelcome" class="text-xl font-semibold text-center mb-2"></h3>
Â  Â  Â  Â  Â  Â  <p id="levelDisplay" class="text-center text-sm mb-2 text-gray-600 dark:text-gray-400"></p>
Â  Â  Â  Â  Â  Â  <div class="text-center mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="scoreDisplay" class="inline-block text-3xl font-bold bg-primary text-white px-6 py-2 rounded-full shadow"></span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p id="rankLabel" class="text-center mb-4 text-lg font-medium text-gray-700 dark:text-gray-300"></p>
Â  Â  Â  Â  Â  Â  <div id="explanations" class="space-y-4 text-sm"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="submissionTimestamp" class="text-center mt-6 text-sm text-gray-500 dark:text-gray-400"></p>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="text-center mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="italic text-sm text-gray-500 dark:text-gray-400"><span id="saveStatus"></span></p>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="restartQuiz()" class="mt-4 bg-secondary text-white px-4 py-2 rounded interactive-element">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Take Another Quiz
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <footer class="text-center py-8 mt-12 border-t border-gray-200 dark:border-gray-700">
Â  Â  Â  Â  <p class="text-sm text-gray-500 dark:text-gray-400">&copy; GrammarBuddy . All Rights Reserved</p>
Â  Â  Â  Â  <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">Designed & Developed by Varun K | Co-Developed by Yuvika V</p>
Â  Â  </footer>


Â  Â  <script>
Â  Â  Â  Â  // State Variables
Â  Â  Â  Â  let allQuizData = [];
Â  Â  Â  Â  let currentQuestions = [];
Â  Â  Â  Â  let currentQuestionIndex = 0;
Â  Â  Â  Â  let userAnswers = {};
Â  Â  Â  Â  let finalScore = 0;
Â  Â  Â  Â  let username = '';
Â  Â  Â  Â  let currentLevel = '';
Â  Â  Â  Â  let submissionTime = null; // Variable to store the submission time
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * @description Parses a CSV string, correctly handling commas inside and outside double quotes.
Â  Â  Â  Â  Â * @param {string} csvText - The raw CSV text from the Google Sheet.
Â  Â  Â  Â  Â * @returns {Array<Object>} An array of objects representing the quiz questions.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function parseCSV(csvText) {
Â  Â  Â  Â  Â  Â  const rows = csvText.trim().split(/\r?\n/);
Â  Â  Â  Â  Â  Â  const headers = rows[0].split(',').map(header => header.trim());
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Regex to split by comma, but not commas inside double quotes
Â  Â  Â  Â  Â  Â  const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

Â  Â  Â  Â  Â  Â  return rows.slice(1).map(rowText => {
Â  Â  Â  Â  Â  Â  Â  Â  const values = rowText.split(regex).map(field => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Remove leading/trailing whitespace and surrounding quotes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return field.trim().replace(/^"|"$/g, '');
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  return headers.reduce((obj, header, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  obj[header] = values[i] || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return obj;
Â  Â  Â  Â  Â  Â  Â  Â  }, {});
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  async function startQuiz() {
Â  Â  Â  Â  Â  Â  username = document.getElementById('usernameInput').value.trim();
Â  Â  Â  Â  Â  Â  currentLevel = document.getElementById('levelSelect').value;
Â  Â  Â  Â  Â  Â  // Replaced alert with a custom function to show a message box
Â  Â  Â  Â  Â  Â  if (!username) { showMessage("GrammarBuddy says: Please enter a username."); return; }
Â  Â  Â  Â  Â  Â  if (!/^[a-zA-Z0-9]{1,10}$/.test(username)) { showMessage("GrammarBuddy says: Username must be 1 to 10 alphanumeric characters."); return; }
Â  Â  Â  Â  Â  Â  if (!currentLevel) { showMessage("GrammarBuddy says: Please select a level."); return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  localStorage.setItem('grammarBuddyUsername', username);
Â  Â  Â  Â  Â  Â  toggleSection('welcomeSection', false);
Â  Â  Â  Â  Â  Â  toggleSection('loadingSection', true);

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (allQuizData.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT4U7NK6M65kZNnINzA10Pxb2-uA2AVG2J0KigQDjFsJHP60VethYK8DEWGwb4N8gdE6oG2omLlKxmu/pub?output=csv';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(sheetUrl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Network response was not ok. Check the Sheet URL.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const csvText = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allQuizData = parseCSV(csvText);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const filtered = allQuizData.filter(q => q.Level === currentLevel);
Â  Â  Â  Â  Â  Â  Â  Â  const shuffled = filtered.sort(() => 0.5 - Math.random());
Â  Â  Â  Â  Â  Â  Â  Â  currentQuestions = shuffled.slice(0, 10);

Â  Â  Â  Â  Â  Â  Â  Â  if (currentQuestions.length < 10) { console.warn(`Warning: Only found ${currentQuestions.length} questions for the level '${currentLevel}'.`); }
Â  Â  Â  Â  Â  Â  Â  Â  if (currentQuestions.length === 0) { showMessage(`Sorry, no questions found for the level '${currentLevel}' in the Google Sheet.`); resetAll(); return; }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  currentQuestionIndex = 0;
Â  Â  Â  Â  Â  Â  Â  Â  userAnswers = {};
Â  Â  Â  Â  Â  Â  Â  Â  toggleSection('loadingSection', false);
Â  Â  Â  Â  Â  Â  Â  Â  toggleSection('quizSection', true);
Â  Â  Â  Â  Â  Â  Â  Â  showQuestion();
Â  Â  Â  Â  Â  Â  Â  Â  updateProgressBar();

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed to load quiz questions:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("An error occurred: " + error.message + "\nPlease make sure the Google Sheet is published and the URL is correct.");
Â  Â  Â  Â  Â  Â  Â  Â  resetAll();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showQuestion() {
Â  Â  Â  Â  Â  Â  const q = currentQuestions[currentQuestionIndex];
Â  Â  Â  Â  Â  Â  document.getElementById('questionText').textContent = `${currentQuestionIndex + 1}. ${q.Question_Text}`;
Â  Â  Â  Â  Â  Â  const optionsDiv = document.getElementById('options');
Â  Â  Â  Â  Â  Â  optionsDiv.innerHTML = '';
Â  Â  Â  Â  Â  Â  const optionsMap = { A: q.Option_A, B: q.Option_B, C: q.Option_C, D: q.Option_D };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Loop through options, only display if the option value is not an empty string
Â  Â  Â  Â  Â  Â  for (let key in optionsMap) {
Â  Â  Â  Â  Â  Â  Â  Â  const optionText = optionsMap[key];
Â  Â  Â  Â  Â  Â  Â  Â  if (optionText.trim() !== '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const label = document.createElement('label');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label.className = 'block border rounded px-4 py-3 cursor-pointer dark:border-gray-600 interactive-element hover:bg-gray-100 dark:hover:bg-gray-700';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label.onclick = () => selectOption(key);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const input = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.type = 'radio'; input.name = 'option'; input.value = key; input.className = 'mr-2 hidden';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label.appendChild(input);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label.appendChild(document.createTextNode(`${key}: ${optionText}`));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  optionsDiv.appendChild(label);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const qid = q.Question_ID;
Â  Â  Â  Â  Â  Â  if (userAnswers[qid]) {
Â  Â  Â  Â  Â  Â  Â  Â  const selectedLabel = optionsDiv.querySelector(`input[value="${userAnswers[qid]}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  if (selectedLabel) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedLabel.parentElement.classList.add('selected-option');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('prevButton').classList.toggle('disabled-button', currentQuestionIndex === 0);
Â  Â  Â  Â  Â  Â  const nextButton = document.getElementById('nextButton');
Â  Â  Â  Â  Â  Â  nextButton.textContent = (currentQuestionIndex === currentQuestions.length - 1) ? 'Submit & See Results' : 'Next';
Â  Â  Â  Â  Â  Â  nextButton.classList.toggle('bg-secondary', currentQuestionIndex === currentQuestions.length - 1);
Â  Â  Â  Â  Â  Â  nextButton.classList.toggle('bg-primary', currentQuestionIndex !== currentQuestions.length - 1);
Â  Â  Â  Â  Â  Â  updateProgressBar();
Â  Â  Â  Â  }

Â  Â  Â  Â  function selectOption(key) {
Â  Â  Â  Â  Â  Â  const qid = currentQuestions[currentQuestionIndex].Question_ID;
Â  Â  Â  Â  Â  Â  userAnswers[qid] = key;
Â  Â  Â  Â  Â  Â  const optionsDiv = document.getElementById('options');
Â  Â  Â  Â  Â  Â  optionsDiv.querySelectorAll('label').forEach(label => label.classList.remove('selected-option'));
Â  Â  Â  Â  Â  Â  const selectedLabel = optionsDiv.querySelector(`input[value="${key}"]`);
Â  Â  Â  Â  Â  Â  if (selectedLabel) {
Â  Â  Â  Â  Â  Â  Â  Â  selectedLabel.parentElement.classList.add('selected-option');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function nextQuestion() {
Â  Â  Â  Â  Â  Â  const qid = currentQuestions[currentQuestionIndex].Question_ID;
Â  Â  Â  Â  Â  Â  // Replaced alert with a custom function to show a message box
Â  Â  Â  Â  Â  Â  if (!userAnswers[qid]) { showMessage("GrammarBuddy says: Please select an option."); return; }
Â  Â  Â  Â  Â  Â  if (currentQuestionIndex < currentQuestions.length - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  currentQuestionIndex++;
Â  Â  Â  Â  Â  Â  Â  Â  showQuestion();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  submitQuiz();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function prevQuestion() {
Â  Â  Â  Â  Â  Â  if (currentQuestionIndex > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  currentQuestionIndex--;
Â  Â  Â  Â  Â  Â  Â  Â  showQuestion();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function submitQuiz() {
Â  Â  Â  Â  Â  Â  updateProgressBar(100);
Â  Â  Â  Â  Â  Â  toggleSection('quizSection', false);
Â  Â  Â  Â  Â  Â  toggleSection('scoringSection', true);
Â  Â  Â  Â  Â  Â  // Corrected logic: Capture the time here, before the timeout
Â  Â  Â  Â  Â  Â  submissionTime = new Date();
Â  Â  Â  Â  Â  Â  let score = 0;
Â  Â  Â  Â  Â  Â  currentQuestions.forEach(q => {
Â  Â  Â  Â  Â  Â  Â  Â  if (userAnswers[q.Question_ID] === q.Correct_Answer) score++;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  finalScore = score;
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  displayResults();
Â  Â  Â  Â  Â  Â  Â  Â  saveScore();
Â  Â  Â  Â  Â  Â  Â  Â  toggleSection('scoringSection', false);
Â  Â  Â  Â  Â  Â  Â  Â  toggleSection('resultSection', true);
Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveScore() {
Â  Â  Â  Â  Â  Â  const saveStatusElement = document.getElementById('saveStatus');
Â  Â  Â  Â  Â  Â  saveStatusElement.textContent = "Saving your score...";
Â  Â  Â  Â  Â  Â  const webAppUrl = 'https://script.google.com/macros/s/AKfycbyx916H_72LsiU9IV7LiFnZJ_wYNyWKbLMTBgvWvN6ZKGy51rc7-ei7nE6mDSLJ3H2f/exec';
Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  username: username,
Â  Â  Â  Â  Â  Â  Â  Â  level: currentLevel,
Â  Â  Â  Â  Â  Â  Â  Â  score: `${finalScore}/${currentQuestions.length}`
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await fetch(webAppUrl, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'no-cors',Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  saveStatusElement.textContent = "Score saved successfully!";
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error saving score:', error);
Â  Â  Â  Â  Â  Â  Â  Â  saveStatusElement.textContent = "Error saving score.";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function displayResults() {
Â  Â  Â  Â  Â  Â  // New line to display the username on the results page
Â  Â  Â  Â  Â  Â  document.getElementById('userWelcome').textContent = `Hi, ${username}!`;

Â  Â  Â  Â  Â  Â  // NEW: Display the selected level on the results page
Â  Â  Â  Â  Â  Â  document.getElementById('levelDisplay').textContent = `Level: ${currentLevel}`;

Â  Â  Â  Â  Â  Â  // Corrected: Display the submission date and time.
Â  Â  Â  Â  Â  Â  if (submissionTime) {
Â  Â  Â  Â  Â  Â  Â  Â  const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
Â  Â  Â  Â  Â  Â  Â  Â  const timeOptions = { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };
Â  Â  Â  Â  Â  Â  Â  Â  const formattedDate = submissionTime.toLocaleDateString('en-US', dateOptions);
Â  Â  Â  Â  Â  Â  Â  Â  const formattedTime = submissionTime.toLocaleTimeString('en-US', timeOptions);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('submissionTimestamp').textContent = `Submitted on ${formattedDate} at ${formattedTime}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback if, for some reason, the time isn't captured
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('submissionTimestamp').textContent = `Submitted on an unknown date.`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('scoreDisplay').textContent = `Score: ${finalScore}/${currentQuestions.length}`;
Â  Â  Â  Â  Â  Â  const rankLabel = document.getElementById('rankLabel');
Â  Â  Â  Â  Â  Â  const scoreRatio = finalScore / currentQuestions.length;
Â  Â  Â  Â  Â  Â  if (scoreRatio === 1) rankLabel.textContent = "ğŸ† Outstanding!";
Â  Â  Â  Â  Â  Â  else if (scoreRatio >= 0.8) rankLabel.textContent = "ğŸ‰ Great job!";
Â  Â  Â  Â  Â  Â  else if (scoreRatio >= 0.5) rankLabel.textContent = "ğŸ‘ Keep practicing!";
Â  Â  Â  Â  Â  Â  else rankLabel.textContent = "ğŸ“š Donâ€™t give up. Try again!";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const explanationsDiv = document.getElementById('explanations');
Â  Â  Â  Â  Â  Â  explanationsDiv.innerHTML = '';
Â  Â  Â  Â  Â  Â  currentQuestions.forEach((q, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  const userAnswer = userAnswers[q.Question_ID];
Â  Â  Â  Â  Â  Â  Â  Â  const isCorrect = userAnswer === q.Correct_Answer;
Â  Â  Â  Â  Â  Â  Â  Â  const icon = isCorrect ? 'âœ…' : 'âŒ';
Â  Â  Â  Â  Â  Â  Â  Â  const panelColor = isCorrect ? 'bg-green-100 dark:bg-green-800' : 'bg-red-100 dark:bg-red-800';
Â  Â  Â  Â  Â  Â  Â  Â  const optionsMap = { A: q.Option_A, B: q.Option_B, C: q.Option_C, D: q.Option_D };
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  card.className = `border rounded ${panelColor} p-3 dark:border-gray-700`;
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `<p class="font-semibold flex items-center mb-2">${icon} ${i + 1}. ${q.Question_Text}</p><p><strong>Your Answer:</strong> ${userAnswer ? `${userAnswer} (${optionsMap[userAnswer]})` : 'Not answered'}</p><p><strong>Correct Answer:</strong> ${q.Correct_Answer} (${optionsMap[q.Correct_Answer]})</p><p class="mt-2"><strong>Explanation:</strong> <span class="italic">${q.Explanation}</span></p>`;
Â  Â  Â  Â  Â  Â  Â  Â  explanationsDiv.appendChild(card);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (scoreRatio >= 0.8) { confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } }); }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function toggleSection(id, show) { document.getElementById(id).classList.toggle('hidden', !show); }
Â  Â  Â  Â  function updateProgressBar(progress) {
Â  Â  Â  Â  Â  Â  const percentage = (progress !== undefined) ? progress : ((currentQuestionIndex / currentQuestions.length) * 100);
Â  Â  Â  Â  Â  Â  document.getElementById('progressBar').style.width = `${percentage}%`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Custom Modal Logic ---
Â  Â  Â  Â  function showMessage(message) {
Â  Â  Â  Â  Â  Â  // You can implement a custom message box here if you want to replace alerts.
Â  Â  Â  Â  Â  Â  // For now, let's keep the alert for simplicity
Â  Â  Â  Â  Â  Â  alert(message);
Â  Â  Â  Â  }

Â  Â  Â  Â  function showCancelModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('cancelModal').classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  function hideCancelModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('cancelModal').classList.add('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  function cancelQuiz() {
Â  Â  Â  Â  Â  Â  hideCancelModal();
Â  Â  Â  Â  Â  Â  resetAll();
Â  Â  Â  Â  }

Â  Â  Â  Â  function restartQuiz() { resetAll(); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function resetAll() {
Â  Â  Â  Â  Â  Â  toggleSection('quizSection', false); toggleSection('resultSection', false); toggleSection('scoringSection', false); toggleSection('welcomeSection', true);
Â  Â  Â  Â  Â  Â  document.getElementById('levelSelect').selectedIndex = 0;
Â  Â  Â  Â  Â  Â  currentQuestions = []; userAnswers = {}; currentQuestionIndex = 0;
Â  Â  Â  Â  Â  Â  updateProgressBar(0);
Â  Â  Â  Â  Â  Â  // Corrected: Also reset the timestamp here
Â  Â  Â  Â  Â  Â  submissionTime = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleTheme() {
Â  Â  Â  Â  Â  Â  const html = document.documentElement;
Â  Â  Â  Â  Â  Â  html.classList.toggle('dark');
Â  Â  Â  Â  Â  Â  const isDarkMode = html.classList.contains('dark');
Â  Â  Â  Â  Â  Â  document.getElementById('themeToggler').textContent = isDarkMode ? 'Light' : 'Dark';
Â  Â  Â  Â  }

Â  Â  Â  Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  Â  Â  Â  Â  const savedUsername = localStorage.getItem('grammarBuddyUsername');
Â  Â  Â  Â  Â  Â  if (savedUsername) { document.getElementById('usernameInput').value = savedUsername; }
Â  Â  Â  Â  Â  Â  const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
Â  Â  Â  Â  Â  Â  if (isDarkMode) { document.documentElement.classList.add('dark'); }Â 
Â  Â  Â  Â  Â  Â  else { document.documentElement.classList.remove('dark'); }
Â  Â  Â  Â  Â  Â  document.getElementById('themeToggler').textContent = isDarkMode ? 'Light' : 'Dark';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- UPDATED: Sidebar Menu Logic ---
Â  Â  Â  Â  Â  Â  const menuBtn = document.getElementById('menu-btn');
Â  Â  Â  Â  Â  Â  const sidebar = document.getElementById('sidebar-menu');
Â  Â  Â  Â  Â  Â  const backdrop = document.getElementById('menu-backdrop');
Â  Â  Â  Â  Â  Â  const cancelBtn = document.getElementById('confirmCancelBtn');
Â  Â  Â  Â  Â  Â  const dismissBtn = document.getElementById('dismissCancelBtn');

Â  Â  Â  Â  Â  Â  const toggleMenu = () => {
Â  Â  Â  Â  Â  Â  Â  Â  menuBtn.classList.toggle('open');
Â  Â  Â  Â  Â  Â  Â  Â  sidebar.classList.toggle('-translate-x-full');
Â  Â  Â  Â  Â  Â  Â  Â  backdrop.classList.toggle('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.toggle('overflow-hidden');
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  menuBtn.addEventListener('click', toggleMenu);
Â  Â  Â  Â  Â  Â  backdrop.addEventListener('click', toggleMenu);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  cancelBtn.addEventListener('click', cancelQuiz);
Â  Â  Â  Â  Â  Â  dismissBtn.addEventListener('click', hideCancelModal);
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
