<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>GrammarBuddy Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#2563eb', // A consistent blue
                            light: '#93c5fd', // Lighter shade for light mode
                            dark: '#1e40af',  // Darker shade for dark mode
                        },
                        secondary: {
                            DEFAULT: '#10b981', // A consistent green for success
                        },
                    },
                },
            },
        };
    </script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .loader {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: currentColor;
            animation: bounce 0.6s infinite alternate;
        }
        .loader:nth-child(2) { animation-delay: 0.2s; }
        .loader:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            from { transform: translateY(0); opacity: 0.3; }
            to { transform: translateY(-0.6rem); opacity: 1; }
        }
        .disabled-button {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .question-transition-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        .question-transition-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .question-transition-exit {
            opacity: 1;
            transform: translateY(0);
        }
        .question-transition-exit-active {
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-in, transform 0.3s ease-in;
        }
    </style>
</head>
<body class="bg-white text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors">
    <div id="quizContainer" class="max-w-xl mx-auto px-4 py-6 shadow rounded-lg min-h-screen">

        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold text-primary dark:text-primary-light">GrammarBuddy</h1>
            <button onclick="toggleTheme()" class="text-sm bg-gray-200 dark:bg-gray-700 dark:text-gray-200 px-3 py-1 rounded">
                Light/Dark
            </button>
        </div>

        <div class="w-full bg-gray-200 dark:bg-gray-700 h-3 rounded mb-4">
            <div id="progressBar" class="bg-primary h-3 rounded transition-all duration-300" style="width: 0%"></div>
        </div>

        <div id="welcomeSection">
            <h1 class="text-3xl font-bold text-center mb-4">
                ðŸŽ“ Welcome to <span class="text-primary dark:text-primary-light">GrammarBuddy!</span>
            </h1>
            <p class="text-center mb-4">Explore English in a whole new way â€” playful, powerful, and for every level!</p>
            
            <input type="text" id="usernameInput" placeholder="Ready to begin? Name your avatar!" maxlength="10" class="w-full border rounded p-2 mb-4 dark:bg-gray-800 dark:border-gray-600" pattern="[a-zA-Z0-9]{1,10}">
            
            <select id="levelSelect" class="w-full border rounded p-2 mb-4 dark:bg-gray-800 dark:border-gray-600">
                <option value="">-- Select Level --</option>
                <option>Pre-KG</option>
                <option>Kindergarten</option>
                <option>Lower Primary (1&2)</option>
                <option>Upper Primary (3-5)</option>
                <option>Middle School (6-8)</option>
                <option>Secondary (9&10)</option>
                <option>Senior Secondary (11&12)</option>
                <option>Graduation</option>
                <option>Post Graduation</option>
                <option>PhD</option>
            </select>
            <button onclick="startQuiz()" class="bg-primary text-white px-4 py-2 rounded w-full">
                Start Quiz
            </button>
        </div>

        <div id="loadingSection" class="hidden text-center py-12">
            <p class="text-lg font-semibold mb-4">Loading your quiz...</p>
            <div class="flex justify-center space-x-2 text-primary dark:text-primary-light">
                <span class="loader"></span>
                <span class="loader"></span>
                <span class="loader"></span>
            </div>
        </div>

        <div id="quizSection" class="hidden">
            <div id="questionContentWrapper" class="transition-all duration-300 ease-in-out">
                <div id="questionText" class="text-lg font-semibold mb-4"></div>
                <div id="options" class="space-y-2 mb-4"></div>
            </div>
            <div class="flex justify-between items-center mt-6">
                <a href="#" onclick="cancelQuiz()" class="text-sm text-red-500 underline">Cancel</a>
                <div class="space-x-2">
                    <button id="prevButton" onclick="prevQuestion()" class="bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white px-3 py-2 rounded disabled-button">
                        Previous
                    </button>
                    <button id="nextButton" onclick="nextQuestion()" class="bg-primary text-white px-4 py-2 rounded">
                        Next
                    </button>
                </div>
            </div>
        </div>

        <div id="scoringSection" class="hidden text-center py-12">
            <p class="text-lg font-semibold mb-4">Calculating your score...</p>
            <div class="flex justify-center space-x-2 text-primary dark:text-primary-light">
                <span class="loader"></span>
                <span class="loader"></span>
                <span class="loader"></span>
            </div>
        </div>

        <div id="resultSection" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-4">Your Results</h2>
            <div class="text-center mb-4">
                <span id="scoreDisplay" class="inline-block text-3xl font-bold bg-primary text-white px-6 py-2 rounded-full shadow"></span>
            </div>
            <p id="rankLabel" class="text-center mb-6 text-lg font-medium text-gray-700 dark:text-gray-300"></p>
            <div id="explanations" class="space-y-4 text-sm"></div>
            <div class="text-center mt-6">
                <p class="italic text-sm text-gray-500 dark:text-gray-400"><span id="saveStatus"></span></p>
                <button onclick="restartQuiz()" class="mt-4 bg-secondary text-white px-4 py-2 rounded">
                    Take Another Quiz
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================================================
        // IMPORTANT: THIS URL IS FOR YOUR GITHUB PAGES DEPLOYMENT
        // IT IS THE API ENDPOINT FOR YOUR APPS SCRIPT WEB APP
        // ====================================================================================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMQFuhAS29kROxlGm9ZqyXarBai5loLtbQ1x5Z3hH1hDwRN6vAe20qWaCTzH_VtdU/exec'; 

        let allQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let currentLevel = '';
        let finalScore = 0;
        let username = '';

        function startQuiz() {
            username = document.getElementById('usernameInput').value.trim();
            const level = document.getElementById('levelSelect').value;

            if (!username) {
                alert("GrammarBuddy says: Please enter a username.");
                return;
            }
            if (!/^[a-zA-Z0-9]{1,10}$/.test(username)) {
                alert("GrammarBuddy says: Username must be 1 to 10 alphanumeric characters.");
                return;
            }
            if (!level) {
                alert("GrammarBuddy says: Please select a level.");
                return;
            }

            currentLevel = level;
            
            toggleSection('welcomeSection', false);
            toggleSection('loadingSection', true);

            // Fetch quiz questions from the Apps Script API endpoint
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'getQuestions',
                    level: level
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    resetAll();
                    return;
                }
                allQuestions = data;
                currentQuestionIndex = 0;
                userAnswers = {};
                toggleSection('loadingSection', false);
                toggleSection('quizSection', true);
                showQuestion();
                updateProgressBar();
            })
            .catch(error => {
                alert("An error occurred: " + error.message);
                resetAll();
            });
        }

        function toggleSection(id, show) {
            document.getElementById(id).classList.toggle('hidden', !show);
        }

        function showQuestion() {
            const questionContentWrapper = document.getElementById('questionContentWrapper');
            const q = allQuestions[currentQuestionIndex];
            
            questionContentWrapper.classList.remove('question-transition-enter-active');
            questionContentWrapper.classList.add('question-transition-exit-active');

            setTimeout(() => {
                document.getElementById('questionText').textContent = `${currentQuestionIndex + 1}. ${q.questionText}`;
                const optionsDiv = document.getElementById('options');
                optionsDiv.innerHTML = '';
                for (let key in q.options) {
                    const option = q.options[key];
                    const label = document.createElement('label');
                    label.className = 'block border rounded px-4 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800';
                    label.onclick = () => selectOption(key);
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'option';
                    input.value = key;
                    input.className = 'mr-2 hidden';
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(`${key}: ${option}`));
                    optionsDiv.appendChild(label);
                }
                const qid = allQuestions[currentQuestionIndex].questionId;
                if (userAnswers[qid]) {
                    const selectedKey = userAnswers[qid];
                    const selectedInput = optionsDiv.querySelector(`input[value="${selectedKey}"]`);
                    if (selectedInput) {
                        selectedInput.checked = true;
                        selectedInput.parentElement.classList.add('bg-primary-light', 'dark:bg-primary-dark');
                    }
                }

                questionContentWrapper.classList.remove('question-transition-exit-active');
                questionContentWrapper.classList.add('question-transition-enter-active');

            }, 300);

            document.getElementById('prevButton').classList.toggle('disabled-button', currentQuestionIndex === 0);
            const nextButton = document.getElementById('nextButton');
            if (currentQuestionIndex === allQuestions.length - 1) {
                nextButton.textContent = 'Submit & See Results';
                nextButton.classList.remove('bg-primary');
                nextButton.classList.add('bg-secondary');
            } else {
                nextButton.textContent = 'Next';
                nextButton.classList.remove('bg-secondary');
                nextButton.classList.add('bg-primary');
            }
            updateProgressBar();
        }

        function selectOption(key) {
            const qid = allQuestions[currentQuestionIndex].questionId;
            userAnswers[qid] = key;
            const optionsDiv = document.getElementById('options');
            optionsDiv.querySelectorAll('label').forEach(label => {
                label.classList.remove('bg-primary-light', 'dark:bg-primary-dark');
            });
            const selectedLabel = optionsDiv.querySelector(`input[value="${key}"]`).parentElement;
            selectedLabel.classList.add('bg-primary-light', 'dark:bg-primary-dark');
        }

        function nextQuestion() {
            const qid = allQuestions[currentQuestionIndex].questionId;
            if (!userAnswers[qid]) {
                alert("GrammarBuddy says: Please select an option.");
                return;
            }

            if (currentQuestionIndex < allQuestions.length - 1) {
                currentQuestionIndex++;
                showQuestion();
            } else {
                submitQuiz();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        function updateProgressBar(progress = (currentQuestionIndex / allQuestions.length) * 100) {
            document.getElementById('progressBar').style.width = `${progress}%`;
        }
        
        function submitQuiz() {
            toggleSection('quizSection', false);
            toggleSection('scoringSection', true);

            // Submit answers to the Apps Script API endpoint
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'submitQuiz',
                    userAnswers: userAnswers
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                    resetAll();
                    return;
                }
                finalScore = result.score;
                displayResults(result);
                updateProgressBar((result.score / result.total) * 100);
                toggleSection('scoringSection', false);
                toggleSection('resultSection', true);
                saveScore();
            })
            .catch(error => {
                alert("An error occurred during submission: " + error.message);
                resetAll();
            });
        }

        function saveScore() {
            const saveStatusElement = document.getElementById('saveStatus');
            saveStatusElement.textContent = "Saving your score...";

            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'saveScore',
                    username: username,
                    level: currentLevel,
                    score: finalScore
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    saveStatusElement.textContent = data.message;
                } else {
                    saveStatusElement.textContent = `Error: ${data.message}`;
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                saveStatusElement.textContent = `Error saving score: ${error.message}`;
            });
        }
        
        function displayResults(result) {
            document.getElementById('scoreDisplay').textContent = `Score: ${result.score}/${result.total}`;
            document.getElementById('rankLabel').textContent =
                result.score === result.total ? "ðŸ† Outstanding!" :
                result.score >= (result.total * 0.8) ? "ðŸŽ‰ Great job!" :
                result.score >= (result.total * 0.5) ? "ðŸ‘ Keep practicing!" : "ðŸ“š Donâ€™t give up. Try again!";
            
            const explanationsDiv = document.getElementById('explanations');
            explanationsDiv.innerHTML = '';
            result.results.forEach((r, i) => {
                const icon = r.isCorrect ? 'âœ…' : 'âŒ';
                const panelColor = r.isCorrect ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900';
                
                const questionInList = allQuestions.find(q => q.questionId === r.questionId);
                
                const card = document.createElement('div');
                card.className = `border rounded ${panelColor} p-3`;
                card.innerHTML = `
                    <p class="font-semibold flex items-center mb-2">
                        ${icon} ${i + 1}. ${r.questionText}
                    </p>
                    <p><strong>Your Answer:</strong> ${r.userAnswer || 'Not answered'} (${questionInList.options[r.userAnswer] || 'No response'})</p>
                    <p><strong>Correct Answer:</strong> ${r.correctAnswer} (${questionInList.options[r.correctAnswer]})</p>
                    <p class="mt-2"><strong>Explanation:</strong> <span class="italic">${r.explanation}</span></p>
                `;
                explanationsDiv.appendChild(card);
            });

            if (result.score >= (result.total * 0.8)) {
                confetti({
                    particleCount: 200,
                    spread: 100,
                    origin: { y: 0.6 }
                });
            }
        }

        function cancelQuiz() {
            if (confirm("GrammarBuddy says: Are you sure you want to cancel the quiz?")) {
                resetAll();
            }
        }

        function restartQuiz() {
            resetAll();
        }

        function resetAll() {
            toggleSection('quizSection', false);
            toggleSection('resultSection', false);
            toggleSection('scoringSection', false);
            toggleSection('welcomeSection', true);
            document.getElementById('levelSelect').selectedIndex = 0;
            allQuestions = [];
            userAnswers = {};
            currentQuestionIndex = 0;
            updateProgressBar(0);
        }

        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            html.classList.toggle('light');
        }

        document.addEventListener("DOMContentLoaded", () => {
            const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.documentElement.classList.remove('light');
            } else {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
            }
        });
    </script>
</body>
</html>
